<!DOCTYPE html>
<head>
    <title>Arrivals and departures in the chosen year</title>
    <div>
        <span id="year">YEAR</span>
        <input type="range" id="rangeInput" name="rangeInput" min="1995" max="2015" value="1995" onchange="updateTextInput(this.value);">
        <input type="text" id="textInput" value="1998">
    </div>
    <div class="chart-example" id="chart1" style="display: inline-block; background-color: White;"><svg></svg></div>
    <div class="chart-example" id="chart2" style="display: inline-block; background-color: White;"><svg></svg></div>
    <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
<script>
    var simulation;
    function updateTextInput(val) { //Para mostrar el año en el slider
        document.getElementById('textInput').value=val;
    }

    d3.csv('data/arrivals-departures.csv', function(error, data) {
        if (error) {
            console.error('Error getting or parsing the data.');
            throw error;
        }
        d3.select("#rangeInput").on("change", function() {
            simulation.alpha(1).restart();
            bubbleChart().width(650).height(700);
             bubbleChart2().width(650).height(700);
            d3.select('#chart1').data(data).call(chart);
             d3.select('#chart2').data(data).call(chart2);

        });

        var chart = bubbleChart().width(650).height(700);
        var chart2 = bubbleChart2().width(650).height(700);
        d3.select('#chart1').data(data).call(chart);
         d3.select('#chart2').data(data).call(chart2);
    });

    function bubbleChart() {
        var width = 960,
            height = 960,
            columnForColors = "year",
            columnForRadius1 = "arrivals",
            columnForTitle = "country",
            border=1,
            bordercolor='black';

        function chart(selection) {
            var data = selection.enter().data();
            var div = selection,
                svg = div.selectAll('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .attr("border",border);

            svg.append("text") //Titulo del grafico
                .attr("x", (width / 2))
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("text-decoration", "underline")
                .style("font-weight", "bold")
                .text("Arrivals");

            var tooltip = selection  //Texto al pasar sobre la burbuja
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("color", "DarkBlue")
                .style("padding", "8px")
                .style("background-color", "CornflowerBlue")
                .style("border-radius", "15px")
                .style("text-align", "center")
                .style("font-family", "monospace")
                .style("width", "140px")
                .text("");

            simulation = d3.forceSimulation(data.filter(function(d){ return d.year==+document.getElementById('textInput').value; }))
                .force("charge", d3.forceManyBody().strength([-50]))
                .force("x", d3.forceX())
                .force("y", d3.forceY())
                // .alpha(1)
                .on("tick", ticked);

            function ticked(e) {   //Define el tamaño de cada circulo
                svg.selectAll("circle").attr("cx", function (d) {
                    return 2 * d.x;
                })
                    .attr("cy", function (d) {
                        return 2 * d.y;
                    });
            }

            var colorCircles1 = d3.scaleLinear()
                .range(["pink", "red"])
                .domain([0, 20000000]);

            var scaleRadius = d3.scaleLinear().domain([d3.min(data, function (d) {
                return +d[columnForRadius1];
            }), d3.max(data, function (d) {
                return +d[columnForRadius1];
            })]).range([5, 60]);

            svg.append("rect") //Recuadro del gráfico
                .attr("x", 0)
                .attr("y", 10)
                .attr("height", height)
                .attr("width", width)
                .style("stroke", bordercolor)
                .style("fill", "none")
                .style("stroke-width", border);

            var node = svg.selectAll("circle")
                .data(data.filter(function(d){return d.year==+document.getElementById('textInput').value;}))
                .enter()
                .append("circle")
                .attr('r', function (d) {
                    return scaleRadius(d[columnForRadius1])
                })
                .style("fill", function (d) {
                    return colorCircles1(d[columnForRadius1])
                })
                .attr('transform', 'translate(' + [width / 2, height / 2] + ')')
                .on("mouseover", function (d) {
                    tooltip.html(d[columnForColors] + "<br>" + d[columnForTitle] + "<br>" + d[columnForRadius1] + " people");
                    return tooltip.style("visibility", "visible");
                })
                .on("mousemove", function () {
                    return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px");
                })
                .on("mouseout", function () {
                    return tooltip.style("visibility", "hidden");
                });

            svg.selectAll("circle")
                .data(data.filter(function(d){return d.year==+document.getElementById('textInput').value;}))
                .attr('r', function (d) {
                    return scaleRadius(d[columnForRadius1])
                })
                .style("fill", function (d) {
                    return colorCircles1(d[columnForRadius1])
                })

        }

        chart.width = function (value) {
            if (!arguments.length) {
                return width;
            }
            width = value;
            return chart;
        };

        chart.height = function (value) {
            if (!arguments.length) {
                return height;
            }
            height = value;
            return chart;
        };

        chart.columnForColors = function (value) {
            if (!arguments.columnForColors) {
                return columnForColors;
            }
            columnForColors = value;
            return chart;
        };

        chart.columnForRadius1 = function (value) {
            if (!arguments.columnForRadius1) {
                return columnForRadius1;
            }
            columnForRadius1 = value;
            return chart;
        };

        return chart;
    }

    function bubbleChart2() {
        var width = 960,
            height = 960,
            columnForColors = "year",
            columnForRadius2 = "departures",
            columnForTitle = "country",
            border=1,
            bordercolor='black';

        function chart2(selection) {
            var data = selection.enter().data();
            var div = selection,
                svg = div.selectAll('svg')
                    .attr('width', width)
                    .attr('height', height);

            svg.append("text")  //Titulo del grafico
                .attr("x", (width / 2))
                .attr("y", 50)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .style("text-decoration", "underline")
                .style("font-weight", "bold")
                .text("Departures");

            var tooltip = selection  //Texto al pasar sobre la burbuja
                .append("div")
                .style("position", "absolute")
                .style("visibility", "hidden")
                .style("color", "DarkBlue")
                .style("padding", "8px")
                .style("background-color", "CornflowerBlue")
                .style("border-radius", "15px")
                .style("text-align", "center")
                .style("font-family", "monospace")
                .style("width", "140px")
                .text("");

            var  simulation2 = d3.forceSimulation(data.filter(function(d){return d.year==+document.getElementById('textInput').value;}))
                .force("charge", d3.forceManyBody().strength([-50]))
                .force("x", d3.forceX())
                .force("y", d3.forceY())
                .on("tick", ticked2);

            function ticked2(e) {   //Define el tamaño de cada circulo
                svg.selectAll("circle").attr("cx", function(d) {
                    return 2*d.x;
                })
                    .attr("cy", function(d) {
                        return 2*d.y;
                    });
            }

            var colorCircles2 = d3.scaleLinear()
                .range(["LightGreen","ForestGreen"])
                .domain([0, 20000000]);

            var scaleRadius = d3.scaleLinear().domain([d3.min(data, function(d) {
                return +d[columnForRadius2];
            }), d3.max(data, function(d) {
                return +d[columnForRadius2];
            })]).range([5, 60]);

            svg.append("rect") //Recuadro del gráfico
                .attr("x", 0)
                .attr("y", 10)
                .attr("height", height)
                .attr("width", width)
                .style("stroke", bordercolor)
                .style("fill", "none")
                .style("stroke-width", border);

            var node2 = svg.selectAll("circle")
                .data(data.filter(function(d){return d.year==+document.getElementById('textInput').value;}))
                .enter()
                .append("circle")
                .attr('r', function(d) {
                    return scaleRadius(d[columnForRadius2])
                })
                .style("fill", function(d) {
                    return colorCircles2(d[columnForRadius2])
                })
                .attr('transform', 'translate(' + [width / 2, height / 2] + ')')
                .on("mouseover", function(d) {
                    tooltip.html(d[columnForColors] + "<br>" + d[columnForTitle] + "<br>" + d[columnForRadius2] + " people");
                    return tooltip.style("visibility", "visible");
                })
                .on("mousemove", function() {
                    return tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px");
                })
                .on("mouseout", function() {
                    return tooltip.style("visibility", "hidden");
                });

            svg.selectAll("circle")
                .data(data.filter(function(d){return d.year==+document.getElementById('textInput').value;}))
                .attr('r', function (d) {
                    return scaleRadius(d[columnForRadius2])
                })
                .style("fill", function (d) {
                    return colorCircles2(d[columnForRadius2])
                })
        }

        chart2.width = function(value) {
            if (!arguments.length) {
                return width;
            }
            width = value;
            return chart2;
        };

        chart2.height = function(value) {
            if (!arguments.length) {
                return height;
            }
            height = value;
            return chart2;
        };

        chart2.columnForColors = function(value) {
            if (!arguments.columnForColors) {
                return columnForColors;
            }
            columnForColors = value;
            return chart2;
        };

        chart2.columnForRadius2 = function(value) {
            if (!arguments.columnForRadius2) {
                return columnForRadius2;
            }
            columnForRadius2 = value;
            return chart2;
        };
        return chart2;
    }



</script>
</body>